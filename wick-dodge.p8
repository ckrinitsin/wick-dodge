pico-8 cartridge // http://www.pico-8.com
version 43
__lua__

function _init()
 if not game_over then
  cartdata(0)
 end
 fire_balls = {}
 game_over=false
 player.sprite=17
 player.timing=0.2
 spawn_rate=0.05
 score=0
 high_score=dget(0)
	palt(12, true)
	palt(0, false)
 music(0)
end

function _update()
 if game_over then
  animate_death()
  if btn(❎) then _init() end
  return
 end
 for fb in all(fire_balls) do
  fb:update()
 end
 player_update()
 update_score()
 update_high_score()
 add_fire_ball()
end

function _draw()
	cls()
	map()
	spr(player.sprite,
	 player.posx-player.radius,
	 player.posy-player.radius)
	for fb in all(fire_balls) do
	 fb:draw()
	end
	draw_score()
	draw_highscore()
	if player.sprite>=player.death_sprite_end then
	 draw_game_over()
	end
end
-->8
player = {
 posx = 50,
 posy = 50,
 velx = 0,
 vely = 0,
 vel_factor = 1,
 vel_loose = 0.75,
 timing = 0.20,
 sprite = 17,
 sprite_end = 20,
 death_sprite = 21,
 death_sprite_end = 28, 
 hitbox_radius = 2,
 radius = 4,
}

function player_update()
	input()
 movement()
 if collision_fire_balls() then
  game_over=true
  dset(0, high_score)
  player.sprite=player.death_sprite
  music(-1)
 end

	animate()
end

function input()
	if btn(0) then player.velx-=player.vel_factor end  --left
	if btn(1) then player.velx+=player.vel_factor end  --right
	if btn(2) then player.vely-=player.vel_factor end  --up
	if btn(3) then player.vely+=player.vel_factor end  --down
end

function map_collision(x,y,flag)
 return fget(mget(x,y),flag)
end

function collision_fire_balls()
 local tolerance = 3
 for fb in all(fire_balls) do
  if abs(player.posx-fb.posx) < tolerance
   and abs(player.posy-fb.posy) < tolerance
   then
    del(fire_balls, fb) 
    return true
   end
 end
 return false
end

function border_collision()
	if map_collision((player.posx-player.hitbox_radius)\8,
	 (player.posy-player.hitbox_radius)\8,0)
      or map_collision((player.posx+player.hitbox_radius)\8,
	    (player.posy+player.hitbox_radius)\8,0)
	 then
	 player.posx-=player.velx
	 player.posy-=player.vely
	 player.velx*=-1
	 player.vely*=-1
	end
end

function movement()
	player.posx+=player.velx
	player.posy+=player.vely
	border_collision()
	player.velx*=player.vel_loose
	player.vely*=player.vel_loose
end

function animate()
 if game_over then return end
 player.sprite+=player.timing
 if player.sprite >= player.sprite_end then player.sprite = 17 end
end

function animate_death()
 player.sprite+=player.timing
 if player.sprite >= player.death_sprite_end then player.timing = 0 end
end
-->8
spawn_rate=0.05
spawn_timer=0

function get_spawn_position()
 pos=rnd(128*4)
 if pos < 128 then
  return pos, 0-10
 elseif pos < 256 then
  return 128+10, pos-128
 elseif pos < 384 then
  return pos-256, 128+10
 else return 0-10, pos-384
 end
end

function get_direction(x,y)
 local dx,dy=player.posx-x,player.posy-y
 dist=sqrt(dx*dx + dy*dy)
 if dist > 0 then
  dx/=dist
  dy/=dist
 end
 return dx,dy
end

function add_fire_ball()
 spawn_timer+=spawn_rate
 if spawn_timer < 1 then return end
 spawn_rate*=1.005
 spawn_timer=0
 local x,y=get_spawn_position()
 local dx,dy=get_direction(x,y)
 add(fire_balls, {
  posx=x,
  posy=y,
  velx=dx,
  vely=dy,
  radius=2,
  draw=function(self)
   spr(33,self.posx-self.radius,self.posy-self.radius)
  end,
  update=function(self)
   self.posx+=self.velx
   self.posy+=self.vely
  end,
 })
end
-->8
score=0
score_delta=1
high_score=0

function update_score()
 score+=score_delta
end

function update_high_score()
 if score>high_score then
  high_score=score
 end
end

function draw_score()
 print(score,8,3,7)
end

function draw_highscore()
 print(high_score,105,3,10)
end

function draw_game_over()
 print("press ❎ to restart",26,40,7)
end
__gfx__
000000006665566666605666d0ddd0dd6566656655555515ddd2dd0000dd2ddddddd2ddd00000000dddd2d0000d2dddddddd2dddddd2ddddddd2dddd00000000
0000000056666665560666650d000d005555555551155555ddd2dd0000dd2ddddddd2ddd00000000dddd2d0000d2dddddddd2dddddd2ddddddd2dddd00000000
007007006655666666506666d0ddd0dd6665666555555115ddd2dd0000dd2dddddddd2ddddddd2ddddddd2dddd2dddddddddd2dddd2ddddddd2ddddd00000000
000770006666665566dad6550d000d005555555555555555ddd2dd0000dd2ddd22dddd22ddddd2dddddddd2222dddddddddddd2222dddddd22dddddd00000000
000770005566666655dad666d0ddd0dd6566656655155555ddd2dd0000dd2ddddd2ddddd22dddd2222dddddddddddd2222dddddddddddd22dddddd2200000000
0070070066665566666d55660d000d005555555555551555ddd2dd0000dd2ddddd2ddddddd2ddddddd2dddddddddd2dddd2dddddddddd2ddddddd2dd00000000
000000006556666665566666d0ddd0dd6665666515555551ddd2dd0000dd2ddd00000000ddd2ddddddd2dddddddd2ddd00d2dddddddd2d00dddd2ddd00000000
0000000066666655666666550d000d005555555555511555ddd2dd0000dd2ddd00000000ddd2ddddddd2dddddddd2ddd00d2dddddddd2d00dddd2ddd00000000
00000000cccccccccccccccccccccccc00000000ccccc9cccccccccccccccccccccccccccccccccccccccccccccccccccccccccc999999999999999900000000
00000000cccc0cccccccccccccc0cccc00000000ccc98ccccccc9c9ccccccccccccccccccccccccccccccccccccccccccccccccc999996966969999900000000
00000000ccccc0ccccc0cccccccc0ccc00000000ccccc0ccccccc8ccccc99cccccc9cccccccccccccccccccccccccccccccccccc99966d6dd6d6699900000000
00000000ccc7776ccccc0cccccc776cc00000000ccc7776cccc7776ccccc8ccccccc9ccccccccccccccccccccccccccccccccccc996dddddddddd69900000000
00000000cc77776cccc776cccc77776c00000000cc77776ccc77776ccc77776ccccc8cccccc9ccccccccc9cccccccccccccccccc996dddddddddd69900000000
00000000cc7776cccc77776ccc77776c00000000cc7776cccc7776cccc7776ccccc776cccccc8cccccc98ccccccc99cccccccccc96dddddddddddd6900000000
00000000cc7776cccc7776ccc77776cc00000000cc7776cccc7776cccc7776cccc7776cccc7776cccccc76cccccc8ccccccccccc96dddddddddddd6900000000
00000000c777776cc777776cc777776c00000000c777776cc777776cc777776ccc77776ccc77776cccc7776cccc7776ccccccccc996ddd6666ddd69900000000
0000000ccccccccc0000000000000000ddadaadadddd2ddd000000000000000996ddddd6888899996ddddd699988888888888888996ddd6666ddd69900000000
0000000ccccccccc0000000000000000ddaaaa9adddd2ddd000000000000000996ddddd6888899996ddddd69999888888888888896dddddddddddd6900000000
0000000cccc82ccc0000000000000000dddaaaadddadadad0000000000000009996ddd658899999956ddd699999888888888888896dddddddddddd6900000000
0000000ccc8882cc0000000000000000dddddddd22aaa9a2000000000000000996ddddd6889999996ddddd699999988888888888996dddddddddd69900000000
0000000ccc8888cc0000000000000000dddddddddd2aaadd000000000000000996ddddd6888899996ddddd699999998888888888996dddddddddd69900000000
0000000cccc88ccc0000000000000000dddddddddd2ddddd0000000000000009996ddd658888889956ddd699988888888888888899966d6dd6d6699900000000
0000000ccccccccc0000000000000000dddddddd00000000000000000000000996ddddd6888999996ddddd699888888888888888999996966969999900000000
0000000ccccccccc0000000000000000dddddddd000000000000000000000009996ddd658888899956ddd6999998888888888888999999999999999900000000
00000000000000000000000000000000000000005555551555555515000000006656656599999999999999998888888888888888000000000000000000000000
0000000000000000000000000000000000000000511555555115555500000000dd6dd6d699999999966969668888888888888888000000000000000000000000
0000000000000000000000000000000000000000555558155555511500000000dddddddd998899996dd6d6dd8888889888888888000000000000000000000000
0000000000000000000000000000000000000000555545555555555500000000dddddddd98889989dddddddd8898889888888888000000000000000000000000
0000000000000000000000000000000000000000551455555544448500000000dddddddd88889889dddddddd8998899988a8a8a8000000000000000000000000
0000000000000000000000000000000000000000554515555555155500000000dd6dd6d688888888dddddddd9999999988aaa9a8000000000000000000000000
000000000000000000000000000000000000000015555551155555510000000066966969888888886dd6d6dd99999999888aaa88000000000000000000000000
00000000000000000000000000000000000000005551155555511555000000009999999988888888566565669999999988888888000000000000000000000000
__gff__
0000000000000101010101010101010000000000000000000000000000010100000000000001000001000100000101000000000000000000010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2c2c2c2c2c2c2c2c2c2c2c2c3c2c2c2c05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2c3b3b3b3b3b3b3b3b3b3b3b3b3b3b2c05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
291d3a3a3a3a3a3a3a3a3a3a3a3a1e2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280536050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
29280505050505050505050505052a2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
292d3838383838383838383838382e2b05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2c39393939393939393939393939392c05050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
011000200e775117750e775117750e775117750e775117750e775117750e775117750e775117750e7751177517775187751777518775177751877517775187751077513775107751377510775137751077513775
0110000000073006003f6000060034673006000060000600000730060000600006003467300600006000060000073006000060000600346733460300600006000007300600006000060034673006000060000600
011000001d3401d3311d3211d3111d3401d3311d3211d311213402133121321213111a3401a3311a3211a3111c3401c3311c3211c311243402433123340233312434024331243212431121340213312132121311
012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0110000000073006000000000073346730060000073000030c0030c00300073006003467300600006000060000073006000007300600346733460300600006000007300600006002460034673006000060000600
011000002d4222d422294222942232422324222b4222b4222942229422284222842229422294222642228422244222442228422284222b4222b42228422284222642226422264222642224422244222442224422
__music__
01 00014244
01 00010244
00 00010244
00 00040244
00 00040244
00 00010205
00 00010205
00 00040205
02 00040205

